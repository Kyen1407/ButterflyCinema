@*
    For more information on enabling MVC for empty projects, visit https://go.microsoft.com/fwlink/?LinkID=397860
*@
@{
    Layout = null;
}

<button class="btn btn-lg btn-success add-food" data-toggle="modal" data-target="#modal-addFood">Thêm món</button>
<button class="btn btn-lg btn-success add-food" data-toggle="modal" data-target="#modal-addCombo">Thêm combo</button>

<!-- Bảng món ăn -->
<table class="table" border="1">
    <thead>
        <tr>
            <th colspan="7">MÓN ĂN</th>
        </tr>
        <tr>
            <th style="width: 5%;">STT</th>
            <th>Mã món</th>
            @*<th>Ảnh</th>*@
            <th>Tên món</th>
            <th>Giá</th>
            <th>Trạng thái</th>
            <th>Thao tác</th>
        </tr>
    </thead>

    <tbody>
        @{
            var index = 1;
        }
        @foreach (var concession in ViewBag.Concessions) {
            <tr>
                <th scope="row" style="text-align: center;">@index</th>
                <td>@concession.ConcessionId</td>
                @*<td><img src="@concession.ConcessionImg" /></td>*@
                <td>@concession.ConcessionName</td>
                <td>@concession.ConcessionPrice</td>
                <td>@(concession.ConcessionStatus != null && concession.ConcessionStatus[0] ? "Còn bán" : "Tạm hết")</td>
                <td>
                    <a asp-action="ConfirmDeleteConcession" asp-route-id="@concession.ConcessionId" class="btn btn-danger">Xóa</a>
                </td>
            </tr>
            index++;
        }
    </tbody>
</table>

<!-- Bảng combo -->
<table class="table" border="1">
    <thead>
        <tr>
            <th colspan="7">COMBO</th>
        </tr>
        <tr>
            <th style="width: 5%;">STT</th>
            <th>Mã combo</th>
            <th>Tên combo</th>
            <th>Chi tiết</th>
            <th>Giá</th>
            <th>Trạng thái</th>
            <th>Thao tác</th>
        </tr>
    </thead>

    <tbody>
        @{
            var comboIndex = 1;
            var comboItems = ViewBag.ComboItems as List<Comboitem>;
            var concessions = ViewBag.Concessions as List<Concession>;
        }

        @foreach (var combo in ViewBag.Combos)
        {
            var lsConcessionId = comboItems
            .Where(c => c.ComboId == combo.ComboId)
            .Select(c => c.ConcessionId)
            .ToList();

            <tr>
                <th scope="row" style="text-align: center;">@comboIndex</th>
                <td>@combo.ComboId</td>
                <td>@combo.ComboName</td>
                <td>
                    @foreach (var i in lsConcessionId)
                    {
                        var concessionName = concessions.FirstOrDefault(c => c.ConcessionId == i)?.ConcessionName;
                        var quantity = comboItems.FirstOrDefault(cb => cb.ComboId == combo.ComboId && cb.ConcessionId == i).Quantity;


                        if (concessionName != null)
                        {
                            <span>@quantity @concessionName <br /></span>
                        }
                    }
                </td>
                <td>@combo.ComboPrice</td>
                <td>@(combo.ComboStatus != null && combo.ComboStatus[0] ? "Còn bán" : "Tạm hết")</td>
                <td>
                    <a asp-action="ConfirmDeleteCombo" asp-route-id="@combo.ComboId" class="btn btn-danger">Xóa</a>
                </td>
            </tr>
            comboIndex++;
        }
    </tbody>
</table>

<!-- Modal thêm món mới -->
<div class="modal fade" id="modal-addFood" role="dialog">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form asp-action="CreateConcession" method="post">
                <!-- Modal body -->
                <div class="modal-body">
                    <div class="col-3">
                        <button type="button" class="close" data-dismiss="modal">&times;</button>
                    </div>
                    <div class="col-6 text-center">
                        <h2>THÊM MÓN ĂN</h2>
                        <p class="modal-title">Nhập đầy đủ thông tin món ăn</p>
                    </div>

                    <div class="form-group mb-3" style="width: 100%;">
                        <label class="form-label" for="idFood">Mã món ăn</label>
                        <input type="text" name="ConcessionId" id="idFood" class="form-control">
                    </div>
                    <div class="form-group mb-3" style="width: 100%;">
                        <label class="form-label" for="foodName">Tên món ăn</label>
                        <input type="text" name="ConcessionName" id="foodName" class="form-control">
                    </div>
                    <div class="form-group mb-3" style="width: 100%;">
                        <label class="form-label" for="foodPrice">Giá bán</label>
                        <input type="number" name="ConcessionPrice" id="foodPrice" class="form-control">
                    </div>
                    <div class="form-group mb-3" style="width: 100%;">
                        <label class="form-label">Trạng thái</label>
                        <div class="row">
                            <div class="col-sm-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="ConcessionStatus" id="stillSale" checked value="1">
                                    <label class="form-check-label" for="stillSale">
                                        Còn bán
                                    </label>
                                </div>
                            </div>
                            <div class="col-sm-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="ConcessionStatus" id="stopSale" value="0">
                                    <label class="form-check-label" for="stopSale">
                                        Tạm ngưng
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Modal footer -->
                <div class="modal-footer">
                    <button type="submit" class="btn btn-danger">Thêm món</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal thêm combo -->
<div class="modal fade" id="modal-addCombo" role="dialog">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form asp-action="CreateCombo" asp-controller="Manage" method="post">
                <div class="modal-body">
                    <div class="col-3">
                        <button type="button" class="close" data-dismiss="modal">&times;</button>
                    </div>
                    <div class="col-6 text-center">
                        <h2>THÊM COMBO</h2>
                        <p class="modal-title">Nhập đầy đủ thông tin combo</p>
                    </div>

                    <div class="form-group mb-3" style="width: 100%;">
                        <label class="form-label" for="idCombo">Mã combo</label>
                        <input type="text" name="ComboId" id="idCombo" class="form-control" required>
                    </div>
                    <div class="form-group mb-3" style="width: 100%;">
                        <label class="form-label" for="comboName">Tên combo</label>
                        <input type="text" name="ComboName" id="comboName" class="form-control" required>
                    </div>
                    <div class="form-group mb-3" style="width: 100%;">
                        <label class="form-label" for="comboPrice">Giá bán</label>
                        <input type="number" name="ComboPrice" id="comboPrice" class="form-control" required>
                    </div>

                    <div class="form-group mb-3" style="width: 100%;">
                        <label class="form-label">Trạng thái</label>
                        <div class="row">
                            <div class="col-sm-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="ComboStatus" id="comboStillSale" checked value="1">
                                    <label class="form-check-label" for="comboStillSale">Còn bán</label>
                                </div>
                            </div>
                            <div class="col-sm-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="ComboStatus" id="comboStopSale" value="0">
                                    <label class="form-check-label" for="comboStopSale">Tạm ngưng</label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <hr />
                    <h4>CHI TIẾT COMBO (Chọn 3 món tối đa)</h4>

                    <div class="row mb-3">
                        <div class="col-sm-6">
                            <label for="concession1">Món ăn 1</label>
                            <select name="ComboItems[0].ConcessionId" id="concession1" class="form-control" required>
                                <option value="">-- Chọn món --</option>
                                @foreach (var concession in ViewBag.Concessions)
                                {
                                    <option value="@concession.ConcessionId">@concession.ConcessionName</option>
                                }
                            </select>
                        </div>
                        <div class="col-sm-6">
                            <label for="quantity1">Số lượng</label>
                            <input type="number" name="ComboItems[0].Quantity" id="quantity1" class="form-control" value="0" min="0" required>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-sm-6">
                            <label for="concession2">Món ăn 2</label>
                            <select name="ComboItems[1].ConcessionId" id="concession2" class="form-control">
                                <option value="">-- Chọn món --</option>
                                @foreach (var concession in ViewBag.Concessions)
                                {
                                    <option value="@concession.ConcessionId">@concession.ConcessionName</option>
                                }
                            </select>
                        </div>
                        <div class="col-sm-6">
                            <label for="quantity2">Số lượng</label>
                            <input type="number" name="ComboItems[1].Quantity" id="quantity2" class="form-control" value="0" min="0">
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-sm-6">
                            <label for="concession3">Món ăn 3</label>
                            <select name="ComboItems[2].ConcessionId" id="concession3" class="form-control">
                                <option value="">-- Chọn món --</option>
                                @foreach (var concession in ViewBag.Concessions)
                                {
                                    <option value="@concession.ConcessionId">@concession.ConcessionName</option>
                                }
                            </select>
                        </div>
                        <div class="col-sm-6">
                            <label for="quantity3">Số lượng</label>
                            <input type="number" name="ComboItems[2].Quantity" id="quantity3" class="form-control" value="0" min="0">
                        </div>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="submit" class="btn btn-danger">Thêm combo</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- SweetAlert2 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        // Xử lý client-side validation
        const form = document.querySelector("#modal-addCombo form");

        if (form) {
            form.addEventListener("submit", function (e) {
                let selectedItems = [];
                let totalQuantity = 0;
                let hasError = false;
                let errorMessage = "";

                for (let i = 0; i < 3; i++) {
                    const foodSelect = document.querySelector(`select[name='ComboItems[${i}].ConcessionId']`);
                    const quantityInput = document.querySelector(`input[name='ComboItems[${i}].Quantity']`);

                    const selectedValue = foodSelect?.value;
                    const quantity = parseInt(quantityInput?.value || "0");

                    if (selectedValue && quantity > 0) {
                        if (selectedItems.includes(selectedValue)) {
                            errorMessage = "Mỗi món ăn chỉ được chọn một lần.";
                            hasError = true;
                            break;
                        }
                        selectedItems.push(selectedValue);
                        totalQuantity += quantity;
                    }
                }

                if (!hasError && totalQuantity < 2) {
                    errorMessage = "Tổng số lượng món ăn phải ít nhất là 2.";
                    hasError = true;
                }

                if (hasError) {
                    e.preventDefault(); // Ngăn gửi form
                    Swal.fire({
                        icon: 'error',
                        title: 'Lỗi nhập liệu',
                        text: errorMessage,
                        confirmButtonText: 'OK'
                    });
                }
            });
        }

        // Nếu có lỗi từ server → hiển thị bằng Swal.fire
        const serverError = @Html.Raw(Json.Serialize(ViewBag.FormError));
        if (serverError) {
            Swal.fire({
                icon: 'error',
                title: 'Lỗi từ máy chủ',
                text: serverError,
                confirmButtonText: 'OK'
            });

            // Mở lại modal nếu có lỗi từ server
            $('#modal-addCombo').modal('show');
        }

        const successMessage = @Html.Raw(Json.Serialize(TempData["SuccessMessage"]));
        if (successMessage) {
            Swal.fire({
                icon: 'success',
                title: 'Thành công',
                text: successMessage,
                confirmButtonText: 'OK'
            });
        }
    });
</script>
